---
title: Verdaccio - Un registre de paquets npm
date: "2020-06-17T18:00:00.000Z"
published: true
ogImage: ./og_image.png
---

> Pr√©sentation de Verdaccio, un outil alternatif √† npm pour tester
> une publication d'un paquet.

## Le probl√®me

Il y a quelques mois, [@IvanDalmet](https://twitter.com/IvanDalmet) et moi avons rencontr√© une probl√©matique lors du d√©veloppement d'un outil en ligne de commande pour [Saagie](https://www.saagie.com/). Nous souhaitions pouvoir tester la publication en `dry-run` (c'est √† dire, faire une publication qui ne soit pas sur le d√©p√¥t [npm](https://www.npmjs.com/)) avec [lerna](https://github.com/lerna/lerna), malheureusement, `lerna` ne permet pas de le faire.

## La solution

Nous avons alors cherch√© une autre solution √† la question : **Comment publier sur un d√©p√¥t autre que le registre npm ?** Et nous sommes tomb√©s sur [Verdaccio](https://verdaccio.org/), un registre de paquets npm installable localement (ou sur un serveur) et sans configuration n√©cessaire ! Et il semblerait que tout un tas d'autres d√©veloppeurs aient rencontr√©s cette probl√©matique avant nous :

<blockquote class="twitter-tweet">
  <p lang="en" dir="ltr">
    Woke up to{" "}
    <a href="https://twitter.com/timer150?ref_src=twsrc%5Etfw">@timer150</a>{" "}
    fixing end-to-end test flakiness in Create React App üëè Background: we have
    a Lerna monorepo and used very complex hacks for integration testing of
    generated projects. Solution: run a local npm registry to simulate a publish
    üòÅ <a href="https://t.co/ggNfS4PpFv">https://t.co/ggNfS4PpFv</a>
  </p>
  &mdash; Dan Abramov (@dan_abramov) <a href="https://twitter.com/dan_abramov/status/951427300070916096?ref_src=twsrc%5Etfw">January 11, 2018</a>
</blockquote> <script
  async
  src="https://platform.twitter.com/widgets.js"
  charset="utf-8"
></script>

[Verdaccio](https://verdaccio.org/en/) ([d√©p√¥t GitHub](https://github.com/verdaccio/verdaccio)) se d√©finit comme un d√©p√¥t et proxy, priv√©, l√©ger et open source pour npm. Ce que je trouve vraiment cool avec cet outil, c'est qu'il fait une chose, et la fait bien.

## Installation via un gestionnaire de paquets

Pour installer Verdaccio, il faut tout d'abord avoir `npm` ou `yarn`, puis lancer la commande :

```bash
npm install --global verdaccio # avec npm
yarn global add verdaccio # avec yarn

verdaccio # lance l'outil afin que le serveur web soit up
```

## Installation via docker

Il est possible de ne pas installer Verdaccio directement sur ton syst√®me mais plut√¥t de passer par `docker` avec la commande suivante :

```bash
docker run -it --rm --name verdaccio -p 4873:4873 verdaccio/verdaccio
```

## Utilisation

Si tu as suivi une des deux m√©thodes d'installation ci-dessus, tu dois avoir la sortie suivante sur ton terminal :

![Verdaccio simple output](./verdaccio-simple-output.png)

Tu peux d√©sormais acc√©der √† l'interface de verdaccio sur [http://localhost:4873](http://localhost:4873) si tu as lanc√© l'outil en ligne de commande, ou bien [http://0.0.0.0:4873](http://0.0.0.0:4873) si lanc√© depuis `docker`.

![Verdaccio web output](./verdaccio-web-output.png)

Cette interface explique comment cr√©er un nouvel utilisateur, il suffit de lancer la commande donn√©e et de se laisser guider par les questions.

```bash
npm adduser --registry http://localhost:4873
```

Maintenant que le serveur est d√©marr√© et que tu es authentifi√©, il est possible de lancer la commande de publication. Pour le projet [@saagie/sdk](https://github.com/saagie/sdk), nous avons cr√©√© une entr√©e dans la partie `script` du `package.json`, car il faut l'avouer, elle est plut√¥t bien fournie en options.

```json
{
  "...": "...",
  "build": "yarn build:webapp && yarn build:sdk",
  "build:webapp": "lerna run build --scope @saagie/sdk-webapp --stream",
  "build:sdk": "lerna run build --scope @saagie/sdk --stream",
  "deploy": "yarn build && lerna publish",
  "verdaccio:publish": "yarn deploy --canary --force-publish --registry http://localhost:4873",
  "verdaccio:unpublish": "version=$(npm view @saagie/sdk dist-tags.canary --registry http://localhost:4873) && npm unpublish @saagie/sdk@${version} --registry=http://localhost:4873",
  "...": "..."
}
```

D√©coupons ensemble les √©tapes du script `verdaccio:publish` :

- Construction des paquets √† publier en utilisant le script `deploy`
- Lancement de la commande `lerna publish` avec les options suivantes
  - `--canary` permet de publier en `alpha`
  - `--force-publish` permet de forcer la publication, m√™me si aucun changement n'a eu lieu depuis la derni√®re publication. Ainsi on peut tester une publication √† tout moment, m√™me sans faire de nouveau commit.
  - `--registry` permet de d√©finir Verdaccio en tant que nouveau registre.

Le script `verdaccio:unpublish` permet ensuite de d√©publier la derni√®re version `canary` qui a √©t√© publi√©e.

En lan√ßant le script sur le projet `@saagie/sdk`, on obtient le r√©sultat suivant pour les logs:

![Verdaccio result output](./verdaccio-result-output.png)

Et le r√©sultat sur l'interface web de Verdaccio :

![Verdaccio result web output](./verdaccio-result-web-output.png)

Voil√† pour une rapide pr√©sentation de Verdaccio. Si tu as des questions suite √† la lecture de cet article, tu peux me retrouver sur [twitter](https://twitter.com/YoannFleuryDev) pour me les poser.
