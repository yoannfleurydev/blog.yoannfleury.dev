---
title: Automatisation du d√©ploiement du blog
date: "2019-07-10T09:00:00.000Z"
published: true
---

import { Warning } from "components/Alert";

<Warning>
  Cet article est un peu vieux, et ce n'est plus de cette fa√ßon que le blog est
  d√©ploy√©.
</Warning>

> Comment ce blog est-il d√©ploy√©, sur quelle infrastructure tourne-t-il, est-ce
> que tout est automatis√© ? Nous allons r√©pondre √† ces questions dans ce billet.

![Sch√©ma du d√©ploiement du blog](./blog-deployment.png)

[Gatsby], c'est chouette, √ßa permet vraiment beaucoup de choses int√©ressantes
pour g√©rer du contenu (j'y reviendrai peut-√™tre lors d'un autre billet de blog),
mais il y avait un truc qui ne me plaisait pas, c'est qu'il fallait que je lance
plusieurs commandes, identiques √† chaque nouvel article, pour mettre √† jour mon
site... Je suis d√©veloppeur, je suis pour l'automatisation, je veux donc
optimiser mon temps et gagner quelques secondes par-ci, par-l√†.

## Github et Github Pages

Le code source du blog est h√©berg√© sur [Github], √† des fins pratiques, car j'ai
toutes mes sources sur cet outil car tous mes projets personnels sont publics
sur le mod√®le du libre et de l'Open Source. [Github] permet de stocker le code
source de vos applications et bien plus, on le verra par la suite.

J'ai cr√©√© le d√©p√¥t de ce blog sous le nom `yoannfleurydev.github.io`, j'en
parlais dans [mon pr√©c√©dent post](../mise-en-place-de-ce-blog) si vous l'avez
manqu√©.

![Catpure d'√©cran du d√©p√¥t sur Github](./repository-name.jpg)

Il faut savoir qu'en faisant cela, j'ai directement acc√®s au [Github Pages] sur
le domaine [yoannfleurydev.github.io](https://yoannfleurydev.github.io). Allez
y, cliquez, vous allez directement retomber sur l'accueil du blog gr√¢ce √† la
redirection que j'ai d√©fini dans les param√®tres du d√©p√¥t.

![Capture d'√©cran des param√®tres de nom de domaine des Github Pages](./repository-settings-domain.png)

Les [Github Pages] permettent l'h√©bergement d'un site statique, personnel ou
bien pour de la documentation de projet. Je ne vais pas m'√©tendre sur le sujet
des Github Pages plus longuement, car la documentation de Github est plut√¥t
bonne √† ce sujet, mais je vais juste pr√©venir que les Github Pages agissent
diff√©remment selon le type de d√©p√¥t:

- Si c'est un d√©p√¥t personnel sous format `username.github.io`, seule la branche
  `master` sera disponible √† l'h√©bergement, il faudra donc comme moi, si vous
  utilisez un outil qui construit votre site statique, le versionner sur une
  autre branche. J'ai pour ma part choisi de nommer cette branche `develop`.
- Si c'est un d√©p√¥t de projet vous pourrez choisir dans les param√®tres du d√©p√¥t
  quelle branche sera disponible √† l'h√©bergement sur le domaine
  `https://username.github.io/repository`. A noter qu'il est √©galement possible
  de donner le dossier `docs/` afin d'√©viter d'avoir deux branches diff√©rentes
  entre le projet et sa documentation.

Pour r√©sumer, avant de tout automatiser, je devais √©crire mes articles, _commit_
et _push_ sur `develop` pour versionner mon code et mes articles, puis lancer
`npm run build` et enfin _commit_ sur la branche `master` seulement les fichiers
construits par la commande de `build` pour ensuite _push_ tout √ßa.

Ma r√©action face √† toutes ces commandes :

![Gif me repr√©sentant choqu√© en voyant toutes les commandes √† lancer](./choque.gif)

C'est contraignant, et j'ai donc d√©cid√© de me simplifier la t√¢che avec une
biblioth√®que `npm`: `gh-pages`.

## gh-pages

La biblioth√®que [gh-pages] permet de se simplifier la vie pour d√©ployer son site
statique sur les [Github Pages]. Avec elle, plus besoin de faire de _commit_ sur
`master` et _push_ sur Github, car une fois configur√©e, elle le fait
automatiquement pour nous en une seule commande.

Il ne me restait plus que deux commandes √† lancer √† partir de maintenant pour
mettre le blog √† jour:

```sh
npm run build
npm run deploy
```

Du coup, pourquoi ne pas optimiser encore et n'en faire qu'une seule, car si je
veux d√©ployer le nouveau site, il faut de toute fa√ßon que je le construise
avant dans tous les cas ! J'ai donc obtenu la commande `deploy` suivante :

```json {5}
// ...
"scripts": {
  "build": "gatsby build",
  "develop": "gatsby develop",
  "deploy": "gatsby build && gh-pages -d public -b master",
  "format": "prettier --write src/**/*.{js,jsx}",
  "start": "npm run develop",
  "serve": "gatsby serve",
  "test": "jest"
}
// ...
```

On lui dit de `build` le site, puis de ne _commit_ que le dossier `public/` sur
la branche `master`. Ainsi, j'√©cris mes articles, et je n'ai plus qu'√† lancer
une seule commande:

```sh {1}
npm run deploy
```

OK, parfait, je gagne quelques secondes petit √† petit. Mais bon, j'ai toujours
une commande √† lancer pour mettre √† jour mon site...

![Gif de la s√©rie Unbreakable Kimmy Schmidt qui repr√©sente ma fain√©antise](https://media.giphy.com/media/FdmPbRxNRGNvq/giphy.gif)

C'est l√† que les [Github Actions] entrent en jeu !

## Github Actions

Les [Github Actions] sont une fonctionnalit√© encore en b√™ta pour le moment, il
faut s'inscrire sur une liste d'attente pour en b√©n√©ficier.

On peut consid√©rer cette nouvelle fonctionnalit√© comme une alternative √† des
services de CI/CD existant d√©j√† sur le march√©. Ce n'est pas aussi puissant, mais
pour mes besoins pour le blog, c'est largement suffisant.

Les Github Actions peuvent √™tre √©dit√©es sous deux formes :

1. Textuellement

```
workflow "Build and Deploy Blog" {
  on = "push"
  resolves = ["Deploy Blog"]
}

action "Install packages" {
  uses = "actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680"
  args = "install"
}

action "Build Blog" {
  uses = "actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680"
  needs = ["Install packages"]
  args = "run build"
}

action "Deploy Blog" {
  needs = "Build Blog"
  uses = "peaceiris/actions-gh-pages@v1.0.1"
  env = {
    PUBLISH_DIR = "./public"
    PUBLISH_BRANCH = "master"
  }
  secrets = [
    "ACTIONS_DEPLOY_KEY",
  ]
}
```

2. Graphiquement

![Capture d'√©cran du mode graphique pour les actions Github](./github-actions-graphical-editor.jpg)

Il est possible d'utiliser des secrets, ce qui est pratique dans mon cas pour
simuler un commit de ma part depuis les actions. Reprenons ensemble le fichier
d'action bloc par bloc :

```
workflow "Build and Deploy Blog" {
  on = "push"
  resolves = ["Deploy Blog"]
}
```

Ce premier bloc d√©fini le nom du _workflow_, l'√©v√©nement √† √©couter pour se
lancer (ici le `push`) et d√©fini √©galement quelle est l'action qui termine le
_workflow_.

```
action "Install packages" {
  uses = "actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680"
  args = "install"
}
```

Cette premi√®re action installe les paquets n√©cessaires √† la bonne construction
du projet. Elle utilise une image d'action `npm` sur le _commit_ `59b64a`. Il
suffit de donner √† cette image un argument, qui est ici `install`, car on
souhaite lancer `npm install` dans le _workflow_.

```
action "Build Blog" {
  uses = "actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680"
  needs = ["Install packages"]
  args = "run build"
}
```

La deuxi√®me action d√©pend de la bonne r√©solution de l'action pr√©c√©dente
`needs = ["Install packages"]` et construit le site statique `npm run build`

```
action "Deploy Blog" {
  needs = "Build Blog"
  uses = "peaceiris/actions-gh-pages@v1.0.1"
  env = {
    PUBLISH_DIR = "./public"
    PUBLISH_BRANCH = "master"
  }
  secrets = [
    "ACTIONS_DEPLOY_KEY",
  ]
}
```

Cette troisi√®me action n'est pas comme les autres car elle utilise une image
qui n'est pas `npm`. Ici, on utilise l'image `peaceiris/actions-gh-pages` qui
permet de d√©ployer sur les Github Pages. Il suffit de lui passer les bons
param√®tres d'environnements ainsi que le secret n√©cessaire pour permettre √†
l'image de faire le _commit_ en notre nom.

![Capture d'√©cran des secrets dans les param√®tres Github](./github-settings-secrets.jpg)

---

> üí° Pour en savoir plus sur les Github Actions, je recommande
> [ce tr√®s bon article](https://css-tricks.com/introducing-github-actions/)
> √©crit par [Sarah Drasner](https://twitter.com/sarah_edo).

---

Et voil√†, nous avons maintenant tout automatiser gr√¢ce aux Github Actions, d√®s
que je _commit_ et _push_ des nouveaut√©s, elles sont automatiquement construites
et d√©ploy√©es. On dispose √©galement d'un suivi de succ√®s ou d'√©checs ainsi que
des logs pour faciliter le d√©bogage si besoin.

![Capture d'√©cran des logs des Github Actions](./github-actions-log.jpg)

Vous avez maintenant toutes les clefs en main pour cr√©er vous m√™me votre blog
et le d√©ployer automatiquement, et tout √ßa, pour 0‚Ç¨.

J'esp√®re avoir fait le tour du propri√©taire le plus clairement possible, si
question il y a, je suis toujours disponible sur
[Twitter](https://twitter.com/yoannfleurydev) et je r√©pondrais avec plaisir.

[gatsby]: https://www.gatsbyjs.org/
[github]: https://github.com
[github actions]: https://github.com/features/actions
[github pages]: https://pages.github.com/
[gh-pages]: https://www.npmjs.com/package/gh-pages
